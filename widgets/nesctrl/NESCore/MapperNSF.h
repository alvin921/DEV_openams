
//////////////////////////////////////////////////////////////////////////
// MapperNSF  NSF:NES Sound Format                                      //
//////////////////////////////////////////////////////////////////////////
#if defined(HAVE_MATH_LIB)  // alvin
#include "math.h"
#endif
#include "mapper.h"

// おまけ
enum	{ STAR_MAX = 128 };

struct	STAR	{
	INT x, y, z;
};

#if defined(HAVE_MATH_LIB) // alvin
static INT Freq2KeyTbl[96+1];
#else
static const int Freq2KeyTbl[96+1]={
8133,8617,9129,9672,10247,10857,11502,12186,
12911,13679,14492,15354,16267,17234,18259,19345,
20495,21714,23005,24373,25822,27358,28985,30708,
32534,34469,36519,38690,40991,43428,46011,48747,
51645,54716,57970,61417,65069,68938,73038,77381,
81982,86857,92022,97494,103291,109433,115940,122834,
130138,137877,146076,154762,163964,173714,184044,194988,
206582,218866,231881,245669,260277,275754,292152,309524,
327929,347429,368088,389976,413165,437733,463762,491339,
520555,551509,584304,619048,655859,694858,736176,779952,
826330,875466,927524,982678,1041111,1103019,1168608,1238097,
1311718,1389717,1472353,1559904,1652661,1750933,1855049,1965356,
2082222,
};
#endif

typedef struct {
	INHERIT_MAPPER;
	
	NSFHEADER	nsfheader;
	BYTE		exchip;
	BYTE		bankswitch;
	INT		banksize;
	BYTE		multipul[2];

	BYTE	exaddr;
	BYTE	exram[128];


	// Song number
	INT	songno;

	// Key buffer
	BYTE	pad, padold;
	BYTE	repcnt;

	struct	STAR	StarBuf[STAR_MAX];
}MapperNSF;
void	MapperNSF_BankSwitch( Mapper *mapper, INT no, BYTE bank );
// For keyboard
INT MapperNSF_GetKeyTable( Mapper *mapper,INT freq );
void	MapperNSF_DrawKey( Mapper *mapper,INT key );

// For Drawing
void	MapperNSF_DrawRect( Mapper *mapper,INT x, INT y, INT w, INT h, BYTE col );
void	MapperNSF_DrawFont( Mapper *mapper,INT x, INT y, BYTE chr, BYTE col );
void	MapperNSF_DrawString(Mapper *mapper, INT x, INT y, char *str, BYTE col );
void	MapperNSF_DrawWave( Mapper *mapper,INT x, INT y, INT col );

void	MapperNSF_DrawBitmap(Mapper *mapper, INT x, INT y, LPBYTE lpBitmap );


void	MapperNSF_StarInitial(Mapper *mapper);
void	MapperNSF_Star(Mapper *mapper);


#define	NSF_PROFILE	0

#if	NSF_PROFILE
static	DWORD	avecount = 0;
static	float	tave = 0.0f;
static	float	pave = 0.0f;
static	float	ptave = 0.0f;
static	DWORD	maxtotalclk = 0;
static	DWORD	maxprofclk = 0;
static	DWORD	maxproftotalclk = 0;
static	DWORD	maxproftotalcnt = 0;
#endif

const BYTE	Font6x8[] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00,
	0x50,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x00,
	0x20,0x78,0xA0,0x70,0x28,0xF0,0x20,0x00,0x48,0xB0,0x50,0x20,0x50,0x68,0x90,0x00,
	0x40,0xA0,0xA8,0x68,0x90,0x90,0x68,0x00,0x30,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
	0x10,0x20,0x40,0x40,0x40,0x20,0x10,0x00,0x40,0x20,0x10,0x10,0x10,0x20,0x40,0x00,
	0x00,0x88,0x50,0x20,0x50,0x88,0x00,0x00,0x00,0x20,0x20,0xF8,0x20,0x20,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x40,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x08,0x10,0x10,0x20,0x40,0x40,0x80,0x00,
	0x70,0x88,0x98,0xA8,0xC8,0x88,0x70,0x00,0x20,0x60,0x20,0x20,0x20,0x20,0xF8,0x00,
	0x70,0x88,0x08,0x30,0x40,0x80,0xF8,0x00,0x70,0x88,0x08,0x30,0x08,0x88,0x70,0x00,
	0x30,0x50,0x90,0x90,0xF8,0x10,0x10,0x00,0xF8,0x80,0x80,0xF0,0x08,0x08,0xF0,0x00,
	0x70,0x88,0x80,0xF0,0x88,0x88,0x70,0x00,0xF8,0x08,0x10,0x10,0x20,0x20,0x20,0x00,
	0x70,0x88,0x88,0x70,0x88,0x88,0x70,0x00,0x70,0x88,0x88,0x78,0x08,0x88,0x70,0x00,
	0x00,0x20,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x20,0x40,0x00,
	0x10,0x20,0x40,0x80,0x40,0x20,0x10,0x00,0x00,0x00,0xF8,0x00,0xF8,0x00,0x00,0x00,
	0x40,0x20,0x10,0x08,0x10,0x20,0x40,0x00,0x70,0x88,0x08,0x10,0x20,0x00,0x20,0x00,
	0x30,0x48,0x88,0x98,0xA8,0xA8,0x78,0x00,0x20,0x50,0x50,0x88,0xF8,0x88,0x88,0x00,
	0xF0,0x88,0x88,0xF0,0x88,0x88,0xF0,0x00,0x70,0x88,0x80,0x80,0x80,0x88,0x70,0x00,
	0xF0,0x88,0x88,0x88,0x88,0x88,0xF0,0x00,0xF8,0x80,0x80,0xF0,0x80,0x80,0xF8,0x00,
	0xF8,0x80,0x80,0xF0,0x80,0x80,0x80,0x00,0x70,0x88,0x80,0xB8,0x88,0x88,0x70,0x00,
	0x88,0x88,0x88,0xF8,0x88,0x88,0x88,0x00,0xF8,0x20,0x20,0x20,0x20,0x20,0xF8,0x00,
	0x38,0x08,0x08,0x08,0x08,0x88,0x70,0x00,0x88,0x88,0x90,0xE0,0x90,0x88,0x88,0x00,
	0x80,0x80,0x80,0x80,0x80,0x80,0xF8,0x00,0x88,0xD8,0xA8,0xA8,0xA8,0xA8,0xA8,0x00,
	0x88,0xC8,0xA8,0xA8,0xA8,0x98,0x88,0x00,0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00,
	0xF0,0x88,0x88,0xF0,0x80,0x80,0x80,0x00,0x70,0x88,0x88,0x88,0xA8,0x90,0x68,0x00,
	0xF0,0x88,0x88,0xF0,0x88,0x88,0x88,0x00,0x70,0x88,0x80,0x70,0x08,0x88,0x70,0x00,
	0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00,
	0x88,0x88,0x88,0x50,0x50,0x50,0x20,0x00,0x88,0xA8,0xA8,0xA8,0xA8,0xD8,0x88,0x00,
	0x88,0x88,0x50,0x20,0x50,0x88,0x88,0x00,0x88,0x88,0x88,0x70,0x20,0x20,0x20,0x00,
	0xF8,0x08,0x10,0x20,0x40,0x80,0xF8,0x00,0x70,0x40,0x40,0x40,0x40,0x40,0x70,0x00,
	0x88,0x50,0xF8,0x20,0xF8,0x20,0x20,0x00,0x70,0x10,0x10,0x10,0x10,0x10,0x70,0x00,
	0x20,0x50,0x88,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00,
	0x80,0xC0,0xE0,0xF0,0xE0,0xC0,0x80,0x00,0x00,0x00,0x70,0x08,0x78,0x88,0xF8,0x00,
	0x80,0x80,0x80,0xF0,0x88,0x88,0xF0,0x00,0x00,0x00,0x78,0x80,0x80,0x80,0x78,0x00,
	0x08,0x08,0x08,0x78,0x88,0x88,0x78,0x00,0x00,0x00,0x70,0x88,0xF8,0x80,0x78,0x00,
	0x18,0x20,0xF8,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x78,0x88,0x78,0x08,0xF0,0x00,
	0x80,0x80,0x80,0xF0,0x88,0x88,0x88,0x00,0x20,0x00,0x20,0x20,0x20,0x20,0x20,0x00,
	0x20,0x00,0x20,0x20,0x20,0x20,0xC0,0x00,0x80,0x80,0x88,0x90,0xE0,0x90,0x88,0x00,
	0x20,0x20,0x20,0x20,0x20,0x20,0x30,0x00,0x00,0x00,0xF0,0xA8,0xA8,0xA8,0xA8,0x00,
	0x00,0x00,0xF0,0x88,0x88,0x88,0x88,0x00,0x00,0x00,0x70,0x88,0x88,0x88,0x70,0x00,
	0x00,0x00,0xF0,0x88,0xF0,0x80,0x80,0x00,0x00,0x00,0x78,0x88,0x78,0x08,0x08,0x00,
	0x00,0x00,0xB8,0xC0,0x80,0x80,0x80,0x00,0x00,0x00,0x78,0x80,0x70,0x08,0xF0,0x00,
	0x20,0x20,0xF8,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x88,0x88,0x88,0x88,0x70,0x00,
	0x00,0x00,0x88,0x88,0x50,0x50,0x20,0x00,0x00,0x00,0x88,0xA8,0xA8,0xD8,0x88,0x00,
	0x00,0x00,0x88,0x50,0x20,0x50,0x88,0x00,0x00,0x00,0x88,0x88,0x78,0x08,0xF0,0x00,
	0x00,0x00,0xF8,0x08,0x70,0x80,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

const BYTE	KeyBoardBitmap[] = {
	48, 26,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x10, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x20,
	0x0F, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20,
	0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x10,
	0x10, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x20,
	0x20, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x20,
	0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x20, 0x20, 0x20,
	0x20, 0x10, 0x0F, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0F, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10,
	0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10,
	0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
};

// KeyA(6x26)
BYTE	KeyBitmapA[] = {
	6, 26,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x2A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF,
	0x2A, 0x2A, 0x2A, 0x2A, 0x0F, 0x0F, 0x2A, 0x2A, 0x2A, 0x2A, 0x0F, 0x0F,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x1A, 0x2A, 0x2A, 0x2A, 0x2A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
};
// KeyB(6x26)
BYTE	KeyBitmapB[] = {
	6, 26,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF, 0xFF, 0xFF, 0x1A, 0x2A, 0xFF, 0xFF,
	0x0F, 0x0F, 0x1A, 0x2A, 0x0F, 0x0F, 0x0F, 0x0F, 0x2A, 0x2A, 0x0F, 0x0F,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x1A, 0x2A, 0x2A, 0x2A, 0x2A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
};
// KeyC(6x26)
BYTE	KeyBitmapC[] = {
	6, 26,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A, 0xFF, 0xFF, 0x1A, 0x2A, 0x2A, 0x2A,
	0x0F, 0x0F, 0x1A, 0x2A, 0x2A, 0x2A, 0x0F, 0x0F, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A,
	0x1A, 0x2A, 0x2A, 0x2A, 0x2A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
};
// KeyD(5x16)
BYTE	KeyBitmapD[] = {
	5, 16,
	0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x2A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x2A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x2A, 0x1A, 0x1A, 0x1A,
	0x1A, 0x2A, 0x2A, 0x2A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
};

// ネオン管(のつもり)
BYTE	NeonBitmapA[] = {
	6, 26,
	0xFF, 0x02, 0x12, 0x12, 0x02, 0xFF, 0x02, 0x12, 0x21, 0x21, 0x12, 0x02,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x12, 0x21, 0x31, 0x31, 0x21, 0x12, 0x12, 0x21, 0x31, 0x31, 0x21, 0x12,
	0x02, 0x12, 0x21, 0x21, 0x12, 0x02, 0xFF, 0x02, 0x12, 0x12, 0x02, 0xFF,
};

BYTE	NeonBitmapB[] = {
	6, 26,
	0xFF, 0x09, 0x1A, 0x1A, 0x09, 0xFF, 0x09, 0x1A, 0x2A, 0x2A, 0x1A, 0x09,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A, 0x1A, 0x2A, 0x3B, 0x3B, 0x2A, 0x1A,
	0x09, 0x1A, 0x2A, 0x2A, 0x1A, 0x09, 0xFF, 0x09, 0x1A, 0x1A, 0x09, 0xFF,
};

BYTE	NeonBitmapC[] = {
	6, 26,
	0xFF, 0x1E, 0x1D, 0x1D, 0x1E, 0xFF, 0x1E, 0x1D, 0x2D, 0x2D, 0x1D, 0x1E,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D, 0x1D, 0x2D, 0x00, 0x00, 0x2D, 0x1D,
	0x1E, 0x1D, 0x2D, 0x2D, 0x1D, 0x1E, 0xFF, 0x1E, 0x1D, 0x1D, 0x1E, 0xFF,
};

INT	KeyBitmapOfs[] = {
	0, 4, 7, 11, 14, 21, 25, 28, 32, 35, 39, 42,
};

LPBYTE	KeyBitmapTbl[] = {
	KeyBitmapA,
	KeyBitmapD,
	KeyBitmapB,
	KeyBitmapD,
	KeyBitmapC,
	KeyBitmapA,
	KeyBitmapD,
	KeyBitmapB,
	KeyBitmapD,
	KeyBitmapB,
	KeyBitmapD,
	KeyBitmapC,
};

BYTE	StarBitmapA[] = {
	5, 5,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0x2D, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
};
BYTE	StarBitmapB[] = {
	5, 5,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0x1D, 0xFF, 0xFF,
	0xFF, 0x1D, 0x2D, 0x1D, 0xFF,
	0xFF, 0xFF, 0x1D, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
};
BYTE	StarBitmapC[] = {
	5, 5,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0x2D, 0xFF, 0xFF,
	0xFF, 0x2D, 0x10, 0x2D, 0xFF,
	0xFF, 0xFF, 0x2D, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
};
BYTE	StarBitmapD[] = {
	5, 5,
	0xFF, 0xFF, 0x2D, 0xFF, 0xFF,
	0xFF, 0x2D, 0x10, 0x2D, 0xFF,
	0x2D, 0x10, 0x20, 0x10, 0x2D,
	0xFF, 0x2D, 0x10, 0x2D, 0xFF,
	0xFF, 0xFF, 0x2D, 0xFF, 0xFF,
};

LPBYTE	StarBitmapTbl[] = {
	StarBitmapA,
	StarBitmapB,
	StarBitmapC,
	StarBitmapD,
};

void	MapperNSF_Reset(Mapper *mapper)
{
INT	i;

	((MapperNSF *)mapper)->songno = 0;

	((MapperNSF *)mapper)->pad = ((MapperNSF *)mapper)->padold = 0;
	((MapperNSF *)mapper)->repcnt = 0;

	BGPAL[0] = BGPAL[1] = BGPAL[2] = BGPAL[3] = 
	SPPAL[0] = SPPAL[1] = SPPAL[2] = SPPAL[3] = 0x0F;

	((MapperNSF *)mapper)->exaddr = 0;
	ZEROMEMORY( ((MapperNSF *)mapper)->exram, sizeof(((MapperNSF *)mapper)->exram) );

	SetPROM_Bank( 2, WRAM+0xA000, BANKTYPE_RAM );	// 4000-5FFF

	SetPROM_Bank( 3, WRAM+0x0000, BANKTYPE_RAM );	// 6000-7FFF
	SetPROM_Bank( 4, WRAM+0x2000, BANKTYPE_RAM );	// 8000-9FFF
	SetPROM_Bank( 5, WRAM+0x4000, BANKTYPE_RAM );	// A000-BFFF
	SetPROM_Bank( 6, WRAM+0x6000, BANKTYPE_RAM );	// C000-DFFF
	SetPROM_Bank( 7, WRAM+0x8000, BANKTYPE_RAM );	// E000-FFFF

	((MapperNSF *)mapper)->nsfheader = *(ROM_GetNsfHeader(mapper->nes->rom));
	((MapperNSF *)mapper)->exchip = ((MapperNSF *)mapper)->nsfheader.ExtraChipSelect;
	((MapperNSF *)mapper)->banksize = ROM_GetNSF_SIZE(mapper->nes->rom);

	if( (((MapperNSF *)mapper)->songno = ((MapperNSF *)mapper)->nsfheader.StartSong-1) >= ((MapperNSF *)mapper)->nsfheader.TotalSong ) {
		((MapperNSF *)mapper)->songno = 0;
	}

	((MapperNSF *)mapper)->bankswitch = 0;
	for( i = 0; i < 8; i++ ) {
		((MapperNSF *)mapper)->bankswitch |= ((MapperNSF *)mapper)->nsfheader.BankSwitch[i];
	}

	if( ((MapperNSF *)mapper)->bankswitch ) {
	// Bankswitch on
		BYTE	start_bank = ((MapperNSF *)mapper)->nsfheader.LoadAddress>>12;
		for( i = 0; (start_bank+i) < 8; i++ ) {
			MapperNSF_BankSwitch(mapper, start_bank+i, i );
		}
		for( i = 0; i < 8; i++ ) {
			MapperNSF_BankSwitch(mapper, i+8, ((MapperNSF *)mapper)->nsfheader.BankSwitch[i] );
		}
		if( ((MapperNSF *)mapper)->exchip&0x04 ) {
			MapperNSF_BankSwitch(mapper, 6, ((MapperNSF *)mapper)->nsfheader.BankSwitch[6] );
			MapperNSF_BankSwitch(mapper, 7, ((MapperNSF *)mapper)->nsfheader.BankSwitch[7] );
		}
	} else {
	// Bankswitch off
		LPBYTE	pPtr = ROM_GetPROM(mapper->nes->rom);
		if( ((MapperNSF *)mapper)->banksize < 8 ) {
			for( i = 0; i < 0x1000*((MapperNSF *)mapper)->banksize; i++ ) {
				if( ((MapperNSF *)mapper)->nsfheader.LoadAddress-0x8000+i < 0x8000 ) {
					WRAM[0x2000+((MapperNSF *)mapper)->nsfheader.LoadAddress-0x8000+i] = pPtr[i];
				}
			}
		} else {
			for( i = 0; i < 0x8000; i++ ) {
				if( ((MapperNSF *)mapper)->nsfheader.LoadAddress-0x8000+i < 0x8000 ) {
					WRAM[0x2000+((MapperNSF *)mapper)->nsfheader.LoadAddress-0x8000+i] = pPtr[i];
				}
			}
		}
	}

	// $4700は待機無限ループ
	WRAM[0xA700] = 0x4c;	//jmp
	WRAM[0xA701] = 0x00;
	WRAM[0xA702] = 0x47;

	// $4710はInitルーチンを呼んだ後無限ループへ
	WRAM[0xA710] = 0x20;	// jsr
	WRAM[0xA711] = (BYTE) ((MapperNSF *)mapper)->nsfheader.InitAddress & 0xFF;
	WRAM[0xA712] = (BYTE)(((MapperNSF *)mapper)->nsfheader.InitAddress>>8);
	WRAM[0xA713] = 0x4c;	// jmp
	WRAM[0xA714] = 0x00;
	WRAM[0xA715] = 0x47;
	
	// $4720はPlayルーチンを呼んだ後無限ループへ
#if	NSF_PROFILE
	WRAM[0xA720] = 0x8D;	// sta
	WRAM[0xA721] = 0x1E;	// $401E
	WRAM[0xA722] = 0x40;	// $401E

	WRAM[0xA723] = 0x20;	// jsr
	WRAM[0xA724] = (BYTE) ((MapperNSF *)mapper)->nsfheader.PlayAddress;
	WRAM[0xA725] = (BYTE)(((MapperNSF *)mapper)->nsfheader.PlayAddress>>8);

	WRAM[0xA726] = 0x8D;	// sta
	WRAM[0xA727] = 0x1F;	// $401F
	WRAM[0xA728] = 0x40;	// $401F

	WRAM[0xA729] = 0x4c;	//jmp
	WRAM[0xA72A] = 0x00;
	WRAM[0xA72B] = 0x47;
#else
	WRAM[0xA720] = 0x20;	// jsr
	WRAM[0xA721] = (BYTE) ((MapperNSF *)mapper)->nsfheader.PlayAddress;
	WRAM[0xA722] = (BYTE)(((MapperNSF *)mapper)->nsfheader.PlayAddress>>8);
	WRAM[0xA723] = 0x4c;	//jmp
	WRAM[0xA724] = 0x00;
	WRAM[0xA725] = 0x47;
#endif

	APU_SelectExSound( mapper->nes->apu, ((MapperNSF *)mapper)->exchip );
	APU_Write( mapper->nes->apu, 0x4015, 0x1F );
	APU_ExWrite( mapper->nes->apu, 0x4080, 0x80 );	// FDS Volume 0
	APU_ExWrite( mapper->nes->apu, 0x408A, 0xE8 );	// FDS Envelope ON

	// For DQ1/2??
	NES_SetFrameIRQmode( mapper->nes, FALSE );

	// NTSC/PAL tune
	NES_SetVideoMode( mapper->nes, (((MapperNSF *)mapper)->nsfheader.NTSC_PALbits&0x01)?TRUE:FALSE );

#if defined(HAVE_MATH_LIB) // alvin
	// 周波数->Keyテーブルの作成
	for( i = 0; i < 12*8+1; i++ ) {
		Freq2KeyTbl[i] = (INT)(440.0*256.0*pow(2.0,((double)(i-45)-0.5)/12.0));
	}
#endif
	// おまけ
	MapperNSF_StarInitial(mapper);

	//
#if	NSF_PROFILE
	avecount = 0;
	tave = 0.0f;
	pave = 0.0f;
	ptave = 0.0f;
	maxtotalclk = 0;
	maxprofclk = 0;
	maxproftotalclk = 0;
	maxproftotalcnt = 0;
#endif
}

BYTE	MapperNSF_ExRead( Mapper *mapper,WORD addr )
{
BYTE	data = 0;

	if( addr >= 0x4040 && addr < 0x4100 ) {
		data = APU_ExRead( mapper->nes->apu, addr );
	}
	return	data;
}

void	MapperNSF_ExWrite( Mapper *mapper,WORD addr, BYTE data )
{
	if( addr >= 0x4040 && addr < 0x4100 ) {
		APU_ExWrite( mapper->nes->apu, addr, data );
	}
}

BYTE	MapperNSF_ReadLow(Mapper *mapper, WORD addr )
{
	if( addr == 0x4800 ) {
		BYTE	data = ((MapperNSF *)mapper)->exram[((MapperNSF *)mapper)->exaddr&0x7F];
		if( ((MapperNSF *)mapper)->exaddr&0x80 )
			((MapperNSF *)mapper)->exaddr = (((MapperNSF *)mapper)->exaddr+1)|0x80;
		APU_ExRead( mapper->nes->apu, addr );
		return	data;
	} else if( addr == 0x5205 ) {	// MMC5
		return	(BYTE)((MapperNSF *)mapper)->multipul[0]*((MapperNSF *)mapper)->multipul[1];
	} else if( addr == 0x5206 ) {	// MMC5
		return	(BYTE)(((WORD)((MapperNSF *)mapper)->multipul[0]*(WORD)((MapperNSF *)mapper)->multipul[1])>>8);
	}
//	if( addr >= 0x47A0 && addr < 0x4800 ) {
//		return	WRAM[addr+0x6000];
//	}
	if( addr >= 0x5C00 && addr < 0x5FFF ) {	// MMC5
		return	DRAM[addr-0x5C00];
	}
	if( addr >= 0x6000 ) {
		return	WRAM[addr-0x6000];
	}

	return	(BYTE)(addr>>8);
}

void	MapperNSF_WriteLow( Mapper *mapper,WORD addr, BYTE data )
{
	if( addr == 0x4800 || (addr >= 0x5000 && addr <= 0x5015) ) {
//DebugOut( "$4800 WR=%02X\n", data );
		((MapperNSF *)mapper)->exram[((MapperNSF *)mapper)->exaddr&0x7F] = data;
		if( ((MapperNSF *)mapper)->exaddr&0x80 )
			((MapperNSF *)mapper)->exaddr = (((MapperNSF *)mapper)->exaddr+1)|0x80;
		APU_ExWrite( mapper->nes->apu, addr, data );
	} else if( addr == 0x5205 ) {	// MMC5
		((MapperNSF *)mapper)->multipul[0] = data;
	} else if( addr == 0x5206 ) {	// MMC5
		((MapperNSF *)mapper)->multipul[1] = data;
	} else if( addr >= 0x5C00 && addr < 0x5FF6 ) {	// MMC5
		DRAM[addr-0x5C00] = data;
	}
//	if( addr >= 0x47A0 && addr < 0x4800 ) {
//		WRAM[addr+0x6000] = data;
//	}
	if( addr >= 0x5FF6 && addr <= 0x5FFF ) {
	// Bank switch
		MapperNSF_BankSwitch(mapper, addr&0x0F, data );
	}
	if( addr >= 0x6000 ) {
		WRAM[addr-0x6000] = data;

		APU_ExWrite( mapper->nes->apu, addr, data );
	}
}

void	MapperNSF_Write(Mapper *mapper, WORD addr, BYTE data )
{
	if( (((MapperNSF *)mapper)->exchip&0x04) ) {
		WRAM[addr-0x6000] = data;
	}
	APU_ExWrite( mapper->nes->apu, addr, data );
	if( addr == 0xF800 ) {
		((MapperNSF *)mapper)->exaddr = data;
	}
}

void	MapperNSF_BankSwitch( Mapper *mapper,INT no, BYTE bank )
{
INT	i;
INT	addr, offs;
LPBYTE	pPtr;

	offs = 0x1000*(INT)bank-(INT)(((MapperNSF *)mapper)->nsfheader.LoadAddress&0x0FFF);
	pPtr = ROM_GetPROM(mapper->nes->rom);

	if( no == 6 || no == 7 ) {
		for( i = 0; i < 0x1000; i++ ) {
			addr = offs+i;
			if( addr < 0 || addr > (4096*((MapperNSF *)mapper)->banksize)-1 ) {
				WRAM[0x1000*(no&1)+i] = 0;
			} else {
				WRAM[0x1000*(no&1)+i] = pPtr[addr];
			}
		}
	} else if( no >= 8 && no <= 15 ) {
		for( i = 0; i < 0x1000; i++ ) {
			addr = offs+i;
			if( addr < 0 || addr > (4096*((MapperNSF *)mapper)->banksize)-1 ) {
				WRAM[0x2000+0x1000*(no&7)+i] = 0;
			} else {
				WRAM[0x2000+0x1000*(no&7)+i] = pPtr[addr];
			}
		}
	}
}

void	MapperNSF_VSync(Mapper *mapper)
{
BYTE	padpush;
	char	str[64];
// データ設定
	((MapperNSF *)mapper)->padold = ((MapperNSF *)mapper)->pad;
	((MapperNSF *)mapper)->pad = PAD_GetNsfController(mapper->nes->pad);
	padpush = ~((MapperNSF *)mapper)->padold & ((MapperNSF *)mapper)->pad;

	if( padpush ) {
		((MapperNSF *)mapper)->repcnt = 20;
	} else if( ((MapperNSF *)mapper)->pad ) {
		if( --((MapperNSF *)mapper)->repcnt == 0 ) {
			((MapperNSF *)mapper)->repcnt = 8;
			padpush |= ((MapperNSF *)mapper)->pad & 0xFC;
		}
	}

	// -1
	if( padpush & (1<<2) ) {
		if( --((MapperNSF *)mapper)->songno < 0 ) {
			((MapperNSF *)mapper)->songno = ((MapperNSF *)mapper)->nsfheader.TotalSong-1;
		}
	}
	// +1
	if( padpush & (1<<3) ) {
		if( ++((MapperNSF *)mapper)->songno >= ((MapperNSF *)mapper)->nsfheader.TotalSong ) {
			((MapperNSF *)mapper)->songno = 0;
		}
	}
	// -16
	if( padpush & (1<<4) ) {
		if( (((MapperNSF *)mapper)->songno-=16) < 0 ) {
			while( ((MapperNSF *)mapper)->songno < 0 ) {
				((MapperNSF *)mapper)->songno += ((MapperNSF *)mapper)->nsfheader.TotalSong;
			}
			((MapperNSF *)mapper)->songno %= ((MapperNSF *)mapper)->nsfheader.TotalSong;
		}
	}
	// +16
	if( padpush & (1<<5) ) {
		if( (((MapperNSF *)mapper)->songno+=16) >= ((MapperNSF *)mapper)->nsfheader.TotalSong ) {
			((MapperNSF *)mapper)->songno -= ((MapperNSF *)mapper)->nsfheader.TotalSong;
			((MapperNSF *)mapper)->songno %= ((MapperNSF *)mapper)->nsfheader.TotalSong;
		}
	}

	// Play
	if( padpush & (1<<0) ) {
		NES_SetNsfPlay( mapper->nes, ((MapperNSF *)mapper)->songno, 0 );
	}

	// Stop
	if( padpush & (1<<1) ) {
		NES_SetNsfStop(mapper->nes);
	}

	// おまけ
	MapperNSF_Star(mapper);

	// Drawing screen
//	MapperNSF_DrawString(mapper, 10, 16, "TITLE :", 0x30 );
//	MapperNSF_DrawString(mapper, 10, 31, "ARTIST:", 0x30 );
//	MapperNSF_DrawString(mapper, 10, 46, "(C)   :", 0x30 );
//	MapperNSF_DrawString(mapper, 10, 61, "NO    :", 0x30 );

	MapperNSF_DrawString(mapper, 10, 16, "Title :", 0x30 );
	MapperNSF_DrawString(mapper, 10, 31, "Artist:", 0x30 );
	MapperNSF_DrawString(mapper, 10, 46, "(C)   :", 0x30 );
	MapperNSF_DrawString(mapper, 10, 61, "No    :", 0x30 );

	MapperNSF_DrawString(mapper, 28,  76, "Keyboard", 0x30 );
	MapperNSF_DrawString(mapper, 32, 152, "Wave View", 0x30 );

	// タイトルなど
	memcpy( str, ((MapperNSF *)mapper)->nsfheader.SongName, 32 );
	str[32] = 0;
	MapperNSF_DrawString(mapper,  53,  16, str, 0x30 );
	memcpy( str, ((MapperNSF *)mapper)->nsfheader.ArtistName, 32 );
	str[32] = 0;
	MapperNSF_DrawString(mapper,  53,  31, str, 0x30 );
	memcpy( str, ((MapperNSF *)mapper)->nsfheader.CopyrightName, 32 );
	str[32] = 0;
	MapperNSF_DrawString(mapper,  53,  46, str, 0x30 );
	// Song no
	sprintf( str, "%02X", ((MapperNSF *)mapper)->songno );
	MapperNSF_DrawString(mapper,  53,  61, str, 0x30 );

	// Extra sound
	MapperNSF_DrawString(mapper, 76+6* 0,  61, "VRC6", (((MapperNSF *)mapper)->exchip&0x01)?0x2B:0x2D );
	MapperNSF_DrawString(mapper, 76+6* 5,  61, "VRC7", (((MapperNSF *)mapper)->exchip&0x02)?0x2B:0x2D );
	MapperNSF_DrawString(mapper, 76+6*10,  61, "FDS",  (((MapperNSF *)mapper)->exchip&0x04)?0x2B:0x2D );
	MapperNSF_DrawString(mapper, 76+6*14,  61, "MMC5", (((MapperNSF *)mapper)->exchip&0x08)?0x2B:0x2D );
	MapperNSF_DrawString(mapper, 76+6*19,  61, "N106", (((MapperNSF *)mapper)->exchip&0x10)?0x2B:0x2D );
//	MapperNSF_DrawString(mapper, 76+6*24,  61, "FME7", (((MapperNSF *)mapper)->exchip&0x20)?0x2B:0x2D );
	MapperNSF_DrawString(mapper, 76+6*24,  61, "SN5B", (((MapperNSF *)mapper)->exchip&0x20)?0x2B:0x2D );

	// タイトルなどのライン
	MapperNSF_DrawRect(mapper,  52, 24, 243-52,   0, 0x30 );
	MapperNSF_DrawRect(mapper,  52, 39, 243-52,   0, 0x30 );
	MapperNSF_DrawRect(mapper,  52, 54, 243-52,   0, 0x30 );
	MapperNSF_DrawRect(mapper,  52, 69, 12,       0, 0x30 );
	MapperNSF_DrawRect(mapper,  75, 69, 243-75,   0, 0x30 );

	// キーボード枠
	MapperNSF_DrawRect(mapper,  27,  84, 229-27, 148- 84, 0x30 );

	// WAVEVIEW枠
#if	!NSF_PROFILE
	MapperNSF_DrawRect(mapper,  31, 160, 224-31, 224-160, 0x30 );
	MapperNSF_DrawRect(mapper,  32, 192, 223-32, 0,       0x27 );

	// Wave
	MapperNSF_DrawWave(mapper, 28+4, 192, 0x2A );
#endif
	// キーボード上段(O5-O8)
	MapperNSF_DrawBitmap(mapper, 31+49*0, 88, KeyBoardBitmap );
	MapperNSF_DrawBitmap(mapper, 31+49*1, 88, KeyBoardBitmap );
	MapperNSF_DrawBitmap(mapper, 31+49*2, 88, KeyBoardBitmap );
	MapperNSF_DrawBitmap(mapper, 31+49*3, 88, KeyBoardBitmap );
	// キーボード下段(O1-O4)
	MapperNSF_DrawBitmap(mapper, 31+49*0, 119, KeyBoardBitmap );
	MapperNSF_DrawBitmap(mapper, 31+49*1, 119, KeyBoardBitmap );
	MapperNSF_DrawBitmap(mapper, 31+49*2, 119, KeyBoardBitmap );
	MapperNSF_DrawBitmap(mapper, 31+49*3, 119, KeyBoardBitmap );

	// キーボードが押されているのを描画
	// Internal APU
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0000)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0001)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0002)) );

	// Internal Noise
	if( APU_GetChannelFrequency(mapper->nes->apu, 0x0003) ) {
		MapperNSF_DrawBitmap(mapper,  10,  88, NeonBitmapA );
		MapperNSF_DrawBitmap(mapper, 241,  88, NeonBitmapA );
		MapperNSF_DrawBitmap(mapper,  10, 119, NeonBitmapA );
		MapperNSF_DrawBitmap(mapper, 241, 119, NeonBitmapA );
	} else {
		MapperNSF_DrawBitmap(mapper,  10,  88, NeonBitmapC );
		MapperNSF_DrawBitmap(mapper, 241,  88, NeonBitmapC );
		MapperNSF_DrawBitmap(mapper,  10, 119, NeonBitmapC );
		MapperNSF_DrawBitmap(mapper, 241, 119, NeonBitmapC );
	}

	// Internal DPCM
	if( APU_GetChannelFrequency(mapper->nes->apu, 0x0004) ) {
		MapperNSF_DrawBitmap(mapper,  18,  88, NeonBitmapB );
		MapperNSF_DrawBitmap(mapper, 233,  88, NeonBitmapB );
		MapperNSF_DrawBitmap(mapper,  18, 119, NeonBitmapB );
		MapperNSF_DrawBitmap(mapper, 233, 119, NeonBitmapB );
	} else {
		MapperNSF_DrawBitmap(mapper,  18,  88, NeonBitmapC );
		MapperNSF_DrawBitmap(mapper, 233,  88, NeonBitmapC );
		MapperNSF_DrawBitmap(mapper,  18, 119, NeonBitmapC );
		MapperNSF_DrawBitmap(mapper, 233, 119, NeonBitmapC );
	}

	// VRC6
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0100)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0101)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0102)) );

	// VRC7
	// Nothing...

	// FDS
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0300)) );

	// MMC5
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0400)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0401)) );

	// N106
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0500)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0501)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0502)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0503)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0504)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0505)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0506)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0507)) );

	// FME7
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0600)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0601)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0602)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0610)) );	// Noise
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0611)) );	// Noise
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0612)) );	// Noise

	// VRC7
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0700)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0701)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0702)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0703)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0704)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0705)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0706)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0707)) );
	MapperNSF_DrawKey(mapper, MapperNSF_GetKeyTable(mapper,APU_GetChannelFrequency(mapper->nes->apu, 0x0708)) );

	// TEST
#if	NSF_PROFILE
	if( mapper->nes->IsNsfPlaying() ) {
		DWORD	total, profile;

		total = NES_GetFrameTotalCycles(mapper->nes);
		profile = NES_GetProfileCycles(mapper->nes);

		if( maxtotalclk < total ) {
			maxtotalclk = total;
		}
		if( maxprofclk < profile ) {
			maxprofclk = profile;
		}
		if( maxproftotalclk < NES_GetProfileTotalCycles(mapper->nes) ) {
			maxproftotalclk = NES_GetProfileTotalCycles(mapper->nes);
		}
		if( maxproftotalcnt < NES_GetProfileTotalCount(mapper->nes) ) {
			maxproftotalcnt = NES_GetProfileTotalCount(mapper->nes);
		}

		tave += total;
		pave += profile;
		ptave += NES_GetProfileTotalCycles(mapper->nes);
		avecount++;

sprintf( str, "TOTAL CLK :%8d", total );
MapperNSF_DrawString(mapper, 16,  160, str, 0x30 );
sprintf( str, "TOTAL MAX :%8d", maxtotalclk );
MapperNSF_DrawString(mapper, 134,  160, str, 0x30 );
sprintf( str, "TOTAL AVE :%8.2f", tave / (float)avecount );
MapperNSF_DrawString(mapper, 16,  168, str, 0x30 );


sprintf( str, "PROFILE   :%8d", profile );
MapperNSF_DrawString(mapper, 16,  176, str, 0x30 );
sprintf( str, "PROFILEMAX:%8d", maxprofclk );
MapperNSF_DrawString(mapper, 134,  176, str, 0x30 );
sprintf( str, "POFILE AVE:%8.2f", pave / (float)avecount );
MapperNSF_DrawString(mapper, 16,  184, str, 0x30 );

sprintf( str, "PRF/TTL  %%:%8.2f", 100.0f * (float)profile / (float)total );
MapperNSF_DrawString(mapper, 16,  192, str, 0x30 );

sprintf( str, "FRM-P TTL :%8d", NES_GetProfileTotalCycles(mapper->nes) );
MapperNSF_DrawString(mapper, 16,  200, str, 0x30 );
sprintf( str, "F-P TTLMAX:%8d", maxproftotalclk );
MapperNSF_DrawString(mapper, 134,  200, str, 0x30 );

sprintf( str, "FRM-P CNT :%8d", NES_GetProfileTotalCount(mapper->nes) );
MapperNSF_DrawString(mapper, 16,  208, str, 0x30 );
sprintf( str, "F-P CNTMAX:%8d", maxproftotalcnt );
MapperNSF_DrawString(mapper, 134,  208, str, 0x30 );

sprintf( str, "F P/T AVE :%8.2f", ptave / (float)avecount );
MapperNSF_DrawString(mapper, 16,  216, str, 0x30 );

sprintf( str, "F PRF/TTL%%:%8.2f", 100.0f * (float)NES_GetProfileTotalCycles(mapper->nes) / (float)total );
MapperNSF_DrawString(mapper, 16,  224, str, 0x30 );

		if( avecount >= 60 ) {
			avecount = 0;
			tave = 0.0f;
			pave = 0.0f;
			ptave = 0.0f;
			maxtotalclk = 0;
			maxprofclk = 0;
			maxproftotalclk = 0;
			maxproftotalcnt = 0;
		}
	}
#endif
}

INT	MapperNSF_GetKeyTable( Mapper *mapper,INT freq )
{
INT	ret = -1;
	INT i;
 
	if( freq < Freq2KeyTbl[0] )
		return	-1;

	for(  i = 0; i < 12*8+1; i++ ) {
		if( freq < Freq2KeyTbl[i] )
			return	ret;
		ret = i;
	}
	return	-1;
}

void	MapperNSF_DrawKey( Mapper *mapper,INT key )
{
	if( key < 0 || key > 12*8-1 )
		return;

	if( key < 12*4 ) {
		MapperNSF_DrawBitmap(mapper, 31+(key/12)*49+KeyBitmapOfs[key%12], 119, KeyBitmapTbl[key%12] );
	} else {
		MapperNSF_DrawBitmap(mapper, 31+((key-12*4)/12)*49+KeyBitmapOfs[key%12], 88, KeyBitmapTbl[key%12] );
	}
}

void	MapperNSF_DrawRect(Mapper *mapper,INT x, INT y, INT w, INT h, BYTE col )
{
INT	i;
LPBYTE	pScn = PPU_GetScreenPtr(mapper->nes->ppu)+8;
LPBYTE	p0, p1;

	p0 = pScn+RENDER_WIDTH*y+x;
	p1 = p0+RENDER_WIDTH*h;
	for( i = 0; i < w+1; i++ ) {
		*p0++ = col;
		*p1++ = col;
	}
	p0 = pScn+RENDER_WIDTH*y+x;
	p1 = p0+w;
	for( i = 0; i < h+1; i++ ) {
		*p0 = col;
		*p1 = col;
		p0 += RENDER_WIDTH;
		p1 += RENDER_WIDTH;
	}
}

void	MapperNSF_DrawFont( Mapper *mapper,INT x, INT y, BYTE chr, BYTE col )
{
INT	i;
LPBYTE	pFnt;
LPBYTE	pPtr;
LPBYTE	pScn = PPU_GetScreenPtr(mapper->nes->ppu)+8;

	if( chr < 0x20 || chr > 0x7F )
		return;
	chr -= 0x20;
	pFnt = (LPBYTE)&Font6x8[chr*8];
	pPtr = pScn+RENDER_WIDTH*y+x;
	for( i = 0; i < 8; i++ ) {
		if( pFnt[i] & 0x80 ) pPtr[0] = col;
		if( pFnt[i] & 0x40 ) pPtr[1] = col;
		if( pFnt[i] & 0x20 ) pPtr[2] = col;
		if( pFnt[i] & 0x10 ) pPtr[3] = col;
		if( pFnt[i] & 0x08 ) pPtr[4] = col;
		if( pFnt[i] & 0x04 ) pPtr[5] = col;
		pPtr += RENDER_WIDTH;
	}
}

void	MapperNSF_DrawString( Mapper *mapper,INT x, INT y, char* str, BYTE col )
{
	while( *str ) {
		MapperNSF_DrawFont(mapper, x, y, (BYTE)*str, col );
		str++;
		x += 6;
	}
}

void	MapperNSF_DrawWave( Mapper *mapper,INT x, INT y, INT col )
{
INT	i, j;
INT	yp, ypold;
LPBYTE	pScn = PPU_GetScreenPtr(mapper->nes->ppu)+8+RENDER_WIDTH*y+x;
LPBYTE	pPtr;
	LPSWORD	pBuffer = (LPSWORD)APU_GetSoundBuffer(mapper->nes->apu);

	ypold = 0;
	for( i = 0; i < 192; i++ ) {
		yp = -((INT)*pBuffer)/1024;
		if( yp < -31 ) yp = -31;
		if( yp >  31 ) yp =  31;
		if( abs( yp-ypold ) <= 1 || i == 0 ) {
			pPtr = pScn+yp*RENDER_WIDTH+i;
			*pPtr = col;
		} else {
		// Line DDA
			INT	xpos, ypos;
			INT	sx, sy;
			xpos = 65536*(i-1)+32768;
			ypos = ypold;
			sy = yp-ypold;
			sx = 65536/abs(sy);
			for( j = 0; j <= abs(sy); j++ ) {
				pPtr = pScn+ypos*RENDER_WIDTH+(xpos/65536);
				*pPtr = col;
				ypos += (sy>0)?1:-1;
				xpos += sx;
			}
		}
		ypold = yp;
		pBuffer++;
	}
}

void	MapperNSF_DrawBitmap( Mapper *mapper,INT x, INT y, LPBYTE lpBitmap )
{
INT	i, j;
INT	h, v;
LPBYTE	pScn = PPU_GetScreenPtr(mapper->nes->ppu)+8+RENDER_WIDTH*y+x;
LPBYTE	pPtr;

	h = (INT)*lpBitmap++;
	v = (INT)*lpBitmap++;

	for( j = 0; j < v; j++ ) {
		pPtr = pScn;
		for( i = 0; i < h; i++ ) {
			if( *lpBitmap != 0xFF ) {
				*pPtr = *lpBitmap;
			}
			lpBitmap++;
			pPtr++;
		}
		pScn += RENDER_WIDTH;
	}
}

void	MapperNSF_StarInitial(Mapper *mapper)
{
	INT i;

 	for(  i = 0; i < STAR_MAX; i++ ) {
		((MapperNSF *)mapper)->StarBuf[i].x = ((rand()%(SCREEN_WIDTH-10))-(SCREEN_WIDTH-10)/2)*256;
		((MapperNSF *)mapper)->StarBuf[i].y = ((rand()%(SCREEN_HEIGHT-10))-(SCREEN_HEIGHT-10)/2)*256;
		((MapperNSF *)mapper)->StarBuf[i].z = (rand()%250)+5;
	}
}

void	MapperNSF_Star(Mapper *mapper)
{
	INT	x, y, z, i;
	for(  i = 0; i < STAR_MAX; i++ ) {
		if( --((MapperNSF *)mapper)->StarBuf[i].z < 5 ) {
		((MapperNSF *)mapper)->StarBuf[i].x = ((rand()%(SCREEN_WIDTH-10))-(SCREEN_WIDTH-10)/2)*256;
		((MapperNSF *)mapper)->StarBuf[i].y = ((rand()%(SCREEN_HEIGHT-10))-(SCREEN_HEIGHT-10)/2)*256;
			((MapperNSF *)mapper)->StarBuf[i].z = 255;
		}

		x = SCREEN_WIDTH/2+(((MapperNSF *)mapper)->StarBuf[i].x-5/128)/((MapperNSF *)mapper)->StarBuf[i].z;
		y = SCREEN_HEIGHT/2+(((MapperNSF *)mapper)->StarBuf[i].y-5/128)/((MapperNSF *)mapper)->StarBuf[i].z;

		if( x < 3 || x >= SCREEN_WIDTH-8 || y < 3 || y >= SCREEN_HEIGHT-8 ) {
			((MapperNSF *)mapper)->StarBuf[i].x = ((rand()%(SCREEN_WIDTH-10))-(SCREEN_WIDTH-10)/2)*256;
			((MapperNSF *)mapper)->StarBuf[i].y = ((rand()%(SCREEN_HEIGHT-10))-(SCREEN_HEIGHT-10)/2)*256;
			((MapperNSF *)mapper)->StarBuf[i].z = 255;
			continue;
		}

		if( ((MapperNSF *)mapper)->StarBuf[i].z > 200 )
			z = 0;
		else if( ((MapperNSF *)mapper)->StarBuf[i].z > 100 )
			z = 1;
		else if( ((MapperNSF *)mapper)->StarBuf[i].z > 50 )
			z = 2;
		else
			z = 3;

		MapperNSF_DrawBitmap(mapper, x, y, StarBitmapTbl[z] );
	}
}

Mapper * MapperNSF_New(NES* parent)
{
	Mapper *mapper = (Mapper *)MALLOC(sizeof(MapperNSF));
	
	memset(mapper, 0, sizeof(MapperNSF));
	mapper->nes = parent;
	memcpy(&mapper->vtbl, &MapperBaseVtbl, sizeof(MapperBaseVtbl));
	mapper->vtbl.Reset = MapperNSF_Reset;
	mapper->vtbl.Write = MapperNSF_Write;
	mapper->vtbl.ExRead = MapperNSF_ExRead;
	mapper->vtbl.ExWrite = MapperNSF_ExWrite;
	mapper->vtbl.ReadLow = MapperNSF_ReadLow;
	mapper->vtbl.WriteLow = MapperNSF_WriteLow;
	mapper->vtbl.VSync = MapperNSF_VSync;

	return (Mapper *)mapper;
}


